# Implementation Plan

- [x] 1. Set up core data models and diff utilities
  - [x] 1.1 Create review models (`vbagent/models/review.py`)
    - Define ReviewIssueType enum, Suggestion, ReviewResult, ReviewStats Pydantic models
    - _Requirements: 2.3, 2.4_
  - [x] 1.2 Write property test for Suggestion model validity
    - **Property 3: Suggestion Model Validity**
    - **Validates: Requirements 2.3, 2.4**
  - [x] 1.3 Create diff utilities (`vbagent/models/diff.py`)
    - Implement generate_unified_diff, apply_diff, parse_diff functions
    - Use Python's difflib for unified diff generation
    - _Requirements: 3.5, 3.6, 4.2_
  - [x] 1.4 Write property test for diff round-trip
    - **Property 4: Diff Round-Trip**
    - **Validates: Requirements 3.5, 3.6**
  - [x] 1.5 Write property test for diff application correctness
    - **Property 5: Diff Application Correctness**
    - **Validates: Requirements 4.2**
  - [x] 1.6 Write property test for failed diff preserves original
    - **Property 13: Failed Diff Preserves Original**
    - **Validates: Requirements 8.1**

- [ ] 2. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 3. Implement Version Store
  - [x] 3.1 Create Version Store database (`vbagent/models/version_store.py`)
    - Define StoredSuggestion dataclass and SuggestionStatus enum
    - Implement VersionStore class with SQLite backend
    - Create tables for suggestions and review_sessions
    - _Requirements: 5.1, 5.2, 5.5_
  - [x] 3.2 Write property test for version store persistence
    - **Property 7: Version Store Persistence**
    - **Validates: Requirements 5.1, 5.2, 5.5**
  - [x] 3.3 Implement version history retrieval methods
    - Add get_versions, get_suggestion, update_status methods
    - _Requirements: 5.3, 5.4_
  - [x] 3.4 Write property test for version history retrieval
    - **Property 8: Version History Retrieval**
    - **Validates: Requirements 5.3**
  - [x] 3.5 Write property test for stored diff application
    - **Property 9: Stored Diff Application**
    - **Validates: Requirements 5.4**
  - [x] 3.6 Implement statistics methods
    - Add get_stats method with date range filtering
    - Add session tracking methods
    - _Requirements: 7.1, 7.3, 7.4_
  - [x] 3.7 Write property test for statistics accumulation
    - **Property 11: Statistics Accumulation**
    - **Validates: Requirements 7.1, 7.3**
  - [x] 3.8 Write property test for date range filtering
    - **Property 12: Date Range Filtering**
    - **Validates: Requirements 7.4**
  - [x] 3.9 Write property test for version data serialization round-trip
    - **Property 10: Version Data Serialization Round-Trip**
    - **Validates: Requirements 5.6**


- [x] 4. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 5. Implement Random Selector
  - [x] 5.1 Create selector module (`vbagent/agents/selector.py`)
    - Define ProblemContext dataclass
    - Implement discover_problems function to find problems in output directory
    - Implement select_random function for random selection
    - Implement load_problem_context to load all files for a problem
    - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_
  - [x] 5.2 Write property test for random selection count constraint
    - **Property 1: Random Selection Count Constraint**
    - **Validates: Requirements 1.1, 1.3**
  - [x] 5.3 Write property test for problem context completeness
    - **Property 2: Problem Context Completeness**
    - **Validates: Requirements 1.2**

- [x] 6. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 7. Implement QA Review Agent
  - [x] 7.1 Create reviewer prompt (`vbagent/prompts/reviewer.py`)
    - Define system prompt for QA review with LaTeX, physics, and variant checking instructions
    - Include structured output format for suggestions
    - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6_
  - [x] 7.2 Create reviewer agent (`vbagent/agents/reviewer.py`)
    - Implement review_problem async function using OpenAI Agents SDK
    - Handle image input for visual review
    - Generate Suggestion objects with diffs
    - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6_
  - [x] 7.3 Write property test for rejected suggestion storage
    - **Property 6: Rejected Suggestion Storage**
    - **Validates: Requirements 4.3**

- [x] 8. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 9. Implement Interactive Review UI
  - [x] 9.1 Create check CLI module (`vbagent/cli/check.py`)
    - Define ReviewAction enum
    - Implement display_diff function with Rich color coding
    - Implement prompt_review_action for user interaction
    - Implement apply_suggestion to apply approved changes
    - _Requirements: 3.1, 3.2, 3.3, 3.4, 4.1, 4.2, 4.3, 4.4, 4.5, 4.6_
  - [x] 9.2 Implement review session orchestration
    - Create run_review_session function
    - Handle approve/reject/skip/edit actions
    - Track session statistics
    - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 7.1, 7.3_
  - [x] 9.3 Implement CLI commands
    - Add `check` command with --count, --problem-id, --dir options
    - Add `check history` subcommand
    - Add `check apply VERSION_ID` subcommand
    - Add `check stats` subcommand with --days option
    - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 6.7_
  - [x] 9.4 Register check command in main CLI
    - Add check command to vbagent/cli/main.py
    - _Requirements: 6.1_

- [x] 10. Implement Error Handling and Recovery
  - [x] 10.1 Add error handling to diff application
    - Handle file not found, permission denied, diff conflicts
    - Preserve original file on failure
    - _Requirements: 8.1, 8.5_
  - [x] 10.2 Add error handling to review agent
    - Implement retry with exponential backoff for API errors
    - Handle invalid responses gracefully
    - _Requirements: 8.2_
  - [x] 10.3 Add session interruption handling
    - Handle SIGINT/SIGTERM for graceful shutdown
    - Save session state for resume capability
    - _Requirements: 8.4_

- [ ] 11. Final Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.
